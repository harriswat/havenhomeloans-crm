// Haven Home Loans CRM - Database Schema
// Complete relationship management, marketing analytics, and payroll automation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

enum UserRole {
  ADMIN
  LOAN_OFFICER
  ASSISTANT
  REFERRAL_PARTNER
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  name      String
  password  String
  role      UserRole
  status    UserStatus @default(ACTIVE)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  sessions            Session[]
  activities          Activity[]
  createdApiKeys      ApiKey[]
  createdSocialPosts  SocialPost[]
  auditLogs           AuditLog[]
  assignedContacts    Contact[]         @relation("AssignedLoanOfficer")
  assignedLoanFiles   LoanFile[]
  referralPartner     ReferralPartner?

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ============================================================================
// CONTACT MANAGEMENT
// ============================================================================

enum ContactStatus {
  LEAD
  PROSPECT
  IN_PROCESS
  PAST_CLIENT
}

model Contact {
  id              String        @id @default(cuid())
  firstName       String
  lastName        String
  email           String        @unique
  phone           String?
  mobilePhone     String?
  street          String?
  city            String?
  state           String?
  zip             String?
  dateOfBirth     DateTime?
  status          ContactStatus @default(LEAD)
  tags            String[]
  leadSourceId    String?
  leadSourceCost  Decimal?      @db.Decimal(10, 2)
  assignedToId    String?
  referredById    String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  leadSource       LeadSource?       @relation(fields: [leadSourceId], references: [id])
  assignedTo       User?             @relation("AssignedLoanOfficer", fields: [assignedToId], references: [id])
  referredBy       ReferralPartner?  @relation(fields: [referredById], references: [id])
  personalDetails  PersonalDetails?
  loanFiles        LoanFile[]
  activities       Activity[]
  campaignExec     CampaignExecution[]
  rateWatch        RateWatch?
  referralTracking ReferralTracking[]

  @@index([status])
  @@index([assignedToId])
  @@index([leadSourceId])
  @@map("contacts")
}

model PersonalDetails {
  id            String   @id @default(cuid())
  contactId     String   @unique
  hobbies       String?
  interests     String?
  familyDetails String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@map("personal_details")
}

model LeadSource {
  id             String    @id @default(cuid())
  name           String    @unique
  totalSpent     Decimal   @default(0) @db.Decimal(10, 2)
  totalLeads     Int       @default(0)
  conversionRate Decimal   @default(0) @db.Decimal(5, 2)
  alertThreshold Decimal   @default(10) @db.Decimal(5, 2)
  isActive       Boolean   @default(true)
  lastAlertSent  DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  contacts Contact[]

  @@map("lead_sources")
}

// ============================================================================
// LOAN TRACKING (PIPELINE VISIBILITY)
// ============================================================================

enum LoanType {
  PURCHASE
  REFINANCE
  HELOC
}

enum LoanFileStatus {
  IN_PROCESS
  CLOSED
  CANCELED
}

model LoanFile {
  id                     String         @id @default(cuid())
  contactId              String
  fileNumber             String         @unique
  loanType               LoanType
  status                 LoanFileStatus @default(IN_PROCESS)
  loanAmount             Decimal        @db.Decimal(12, 2)
  propertyAddress        String
  loanToValue            Decimal?       @db.Decimal(5, 2)
  interestRate           Decimal?       @db.Decimal(5, 3)
  rateLockExpirationDate DateTime?
  closingDate            DateTime?
  fundedDate             DateTime?
  commissionAmount       Decimal?       @db.Decimal(10, 2)
  commissionPaid         Boolean        @default(false)
  assignedLoanOfficerId  String
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt

  // Relations
  contact             Contact            @relation(fields: [contactId], references: [id])
  assignedLoanOfficer User               @relation(fields: [assignedLoanOfficerId], references: [id])
  appraisalTracking   AppraisalTracking?
  milestones          LoanMilestone[]
  referralTracking    ReferralTracking[]

  @@index([status])
  @@index([assignedLoanOfficerId])
  @@index([rateLockExpirationDate])
  @@map("loan_files")
}

model AppraisalTracking {
  id                 String    @id @default(cuid())
  loanFileId         String    @unique
  appraisalOrdered   DateTime?
  appraisalAssigned  DateTime?
  appraisalValue     Decimal?  @db.Decimal(12, 2)
  amcName            String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  loanFile LoanFile @relation(fields: [loanFileId], references: [id], onDelete: Cascade)

  @@map("appraisal_tracking")
}

enum Milestone {
  DOCS_RECEIVED
  APPRAISAL_ORDERED
  APPRAISAL_RECEIVED
  TITLE_CLEAR
  CLEAR_TO_CLOSE
}

enum MilestoneStatus {
  PENDING
  COMPLETE
}

model LoanMilestone {
  id            String          @id @default(cuid())
  loanFileId    String
  milestone     Milestone
  status        MilestoneStatus @default(PENDING)
  completedDate DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  loanFile LoanFile @relation(fields: [loanFileId], references: [id], onDelete: Cascade)

  @@unique([loanFileId, milestone])
  @@map("loan_milestones")
}

// ============================================================================
// REFERRAL PARTNER MANAGEMENT
// ============================================================================

enum PartnerType {
  REALTOR
  FINANCIAL_ADVISOR
  BUILDER
  ATTORNEY
  ACCOUNTANT
  OTHER
}

enum PartnerStatus {
  ACTIVE
  INACTIVE
}

model ReferralPartner {
  id          String        @id @default(cuid())
  name        String
  company     String?
  email       String        @unique
  phone       String?
  partnerType PartnerType
  status      PartnerStatus @default(ACTIVE)
  userId      String?       @unique
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  user             User?              @relation(fields: [userId], references: [id])
  referredContacts Contact[]
  referralTracking ReferralTracking[]

  @@map("referral_partners")
}

model ReferralTracking {
  id                String    @id @default(cuid())
  referralPartnerId String
  contactId         String
  loanFileId        String?
  commissionAmount  Decimal?  @db.Decimal(10, 2)
  commissionPaid    Boolean   @default(false)
  paidDate          DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  referralPartner ReferralPartner @relation(fields: [referralPartnerId], references: [id])
  contact         Contact         @relation(fields: [contactId], references: [id])
  loanFile        LoanFile?       @relation(fields: [loanFileId], references: [id])

  @@map("referral_tracking")
}

// ============================================================================
// ACTIVITY & ENGAGEMENT
// ============================================================================

enum ActivityType {
  CALL
  EMAIL
  MEETING
  NOTE
  SMS
  RATE_ALERT_SENT
  TASK
  OTHER
}

model Activity {
  id            String       @id @default(cuid())
  type          ActivityType
  contactId     String?
  userId        String
  description   String
  scheduledDate DateTime?
  completedDate DateTime?
  metadata      Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  contact Contact? @relation(fields: [contactId], references: [id])
  user    User     @relation(fields: [userId], references: [id])

  @@index([scheduledDate])
  @@index([contactId])
  @@map("activities")
}

model CampaignExecution {
  id           String    @id @default(cuid())
  contactId    String
  campaignName String
  emailSent    Boolean   @default(false)
  emailOpened  Boolean   @default(false)
  linkClicked  Boolean   @default(false)
  response     String?
  sentDate     DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  contact Contact @relation(fields: [contactId], references: [id])

  @@map("campaign_executions")
}

// ============================================================================
// MARKETING & ANALYTICS
// ============================================================================

enum SocialPlatform {
  FACEBOOK
  LINKEDIN
  INSTAGRAM
  TWITTER
  TIKTOK
  OTHER
}

model SocialPost {
  id             String         @id @default(cuid())
  postDate       DateTime
  platform       SocialPlatform
  content        String
  likes          Int            @default(0)
  comments       Int            @default(0)
  shares         Int            @default(0)
  reach          Int            @default(0)
  engagementRate Decimal        @default(0) @db.Decimal(5, 2)
  postUrl        String?
  createdById    String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  createdBy User @relation(fields: [createdById], references: [id])

  @@map("social_posts")
}

model RateWatch {
  id               String    @id @default(cuid())
  contactId        String    @unique
  currentRate      Decimal   @db.Decimal(5, 3)
  targetRate       Decimal   @db.Decimal(5, 3)
  notifyWhenBelow  Boolean   @default(true)
  lastNotifiedDate DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@map("rate_watch")
}

// ============================================================================
// AUDIT TRAIL
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  entityType String
  entityId   String?
  changes    Json?
  ipAddress  String?
  timestamp  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([timestamp])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

// ============================================================================
// SYSTEM
// ============================================================================

model ApiKey {
  id        String   @id @default(cuid())
  name      String
  keyHash   String   @unique
  scopes    Json
  lastUsed  DateTime?
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creator User @relation(fields: [createdBy], references: [id])

  @@map("api_keys")
}

model SystemSetting {
  key       String   @id
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}
